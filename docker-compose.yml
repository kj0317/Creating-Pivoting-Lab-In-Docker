# ══════════════════════════════════════════════════════════════
# Pivoting Lab — docker-compose.yml
# ══════════════════════════════════════════════════════════════
#
#  Network Topology:
#
#   Net A (10.10.1.0/24)     Net B (10.10.2.0/24)     Net C (10.10.3.0/24)
#   ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐
#   │ attacker │──│   pivot1     │──│   pivot2     │──│  target  │
#   │ .1.10    │  │ .1.20 / .2.20│  │ .2.30 / .3.30│  │  .3.40   │
#   └──────────┘  └──────────────┘  └──────────────┘  └──────────┘
#
#  Three tunneling methods supported:
#    1. SSH + proxychains (traditional)
#    2. Chisel (SOCKS over HTTP)
#    3. Ligolo-ng (TUN interface)
#
#  Build & run:
#    docker compose build
#    docker compose up -d
#    docker exec -it attacker bash -l
#
# ══════════════════════════════════════════════════════════════

services:

  # ────────────────────────────────────────────
  # ATTACKER — Your pentest machine
  # ────────────────────────────────────────────
  attacker:
    build:
      context: ./dockerfiles/attacker
      args:
        LIGOLO_VERSION: "0.8.2"
        CHISEL_VERSION: "1.11.3"
    container_name: attacker
    hostname: attacker
    cap_add:
      - NET_ADMIN          # Required: Ligolo-ng needs to create TUN interfaces
    devices:
      - /dev/net/tun       # Required: TUN device for Ligolo-ng proxy
    sysctls:
      - net.ipv4.ip_forward=1   # Allow IP forwarding for routing
    networks:
      net_a:
        ipv4_address: 10.10.1.10
    stdin_open: true
    tty: true

  # ────────────────────────────────────────────
  # PIVOT1 — First compromised host (dual-homed)
  #   Vuln: command injection on web app (port 5000)
  #   SSH:  weak root creds (brute-forceable)
  # ────────────────────────────────────────────
  pivot1:
    build:
      context: ./dockerfiles/pivot1
    container_name: pivot1
    hostname: pivot1
    networks:
      net_a:
        ipv4_address: 10.10.1.20
      net_b:
        ipv4_address: 10.10.2.20

  # ────────────────────────────────────────────
  # PIVOT2 — TODO (second pivot, deeper in network)
  # ────────────────────────────────────────────
  # pivot2:
  #   ...
  #   networks:
  #     net_b:
  #       ipv4_address: 10.10.2.30
  #     net_c:
  #       ipv4_address: 10.10.3.30

  # ────────────────────────────────────────────
  # TARGET — TODO (final target on Net C)
  # ────────────────────────────────────────────
  # target:
  #   ...
  #   networks:
  #     net_c:
  #       ipv4_address: 10.10.3.40

# ══════════════════════════════════════════════════════════════
# Networks — Three isolated segments
# ══════════════════════════════════════════════════════════════
networks:
  # Attacker's network — only attacker and pivot1 can see each other
  net_a:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.1.0/24
          gateway: 10.10.1.1

  # Internal network 1 — pivot1 and pivot2 can see each other
  net_b:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.2.0/24
          gateway: 10.10.2.1

  # Internal network 2 — pivot2 and target can see each other
  net_c:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.3.0/24
          gateway: 10.10.3.1
